{% extends "base.html" %}
{% block title %}AI-UGRS – Portal{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card card-shadow mb-4">
      <div class="card-body text-center p-5">
        <h1 class="mb-3">Welcome to AI-UGRS</h1>
        <p class="text-muted mb-4">
          AI-Driven Unified Grievance Redressal System – a single portal for citizens
          to raise complaints and for departments to resolve them efficiently.
        </p>

        <div class="d-grid gap-3 col-md-6 mx-auto">
          <a href="{{ url_for('citizen_login') }}" class="btn btn-primary btn-lg">
            Citizen Login
          </a>
          <a href="{{ url_for('department_login') }}" class="btn btn-outline-primary btn-lg">
            Department Admin Login
          </a>
          <a href="{{ url_for('official_login') }}" class="btn btn-outline-secondary btn-lg">
            System Admin / Other Officials
          </a>
        </div>

      </div>
    </div>

    <div class="card card-shadow">
      <div class="card-body">
        <h4>About Us</h4>
        <p class="mb-1">
          AI-UGRS provides a transparent and trackable workflow for public grievances.
          Citizens can submit complaints, track their ticket status, and view history.
        </p>
        <p class="mb-0">
          Departments and system administrators can monitor pending issues, resolve
          complaints, and view escalations and heat-map style overviews.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Chatbot Messenger -->
<div id="chatbot-container" class="chatbot-container">
  <div id="chatbot-header" class="chatbot-header">
    <span>AI Assistant</span>
    <button id="chatbot-toggle" class="chatbot-toggle">−</button>
  </div>
  <div id="chatbot-body" class="chatbot-body">
    <div id="chat-messages" class="chat-messages">
      <div class="message bot-message">
        <div class="message-content">
          Hello! I'm your AI assistant. How can I help you today?
        </div>
      </div>
    </div>
    <div class="chat-input-container">
      <div class="input-group">
        <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." autocomplete="off">
        <button id="voice-btn" class="btn btn-outline-secondary" type="button">
          <i class="fas fa-microphone"></i>
        </button>
        <button id="send-btn" class="btn btn-primary" type="button">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
      <div id="voice-status" class="voice-status"></div>
    </div>
  </div>
</div>

<style>
/* Chatbot Styles */
.chatbot-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 350px;
  height: 500px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
  display: flex;
  flex-direction: column;
  z-index: 1000;
  transition: all 0.3s ease;
}

.chatbot-container.minimized {
  height: 50px;
}

.chatbot-header {
  background: #007bff;
  color: white;
  padding: 12px 15px;
  border-radius: 10px 10px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.chatbot-toggle {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

.chatbot-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chatbot-container.minimized .chatbot-body {
  display: none;
}

.chat-messages {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.message {
  display: flex;
  margin-bottom: 10px;
}

.user-message {
  justify-content: flex-end;
}

.bot-message {
  justify-content: flex-start;
}

.message-content {
  max-width: 80%;
  padding: 10px 15px;
  border-radius: 18px;
  word-wrap: break-word;
}

.user-message .message-content {
  background: #007bff;
  color: white;
  border-bottom-right-radius: 5px;
}

.bot-message .message-content {
  background: #f1f1f1;
  color: #333;
  border-bottom-left-radius: 5px;
}

.chat-input-container {
  padding: 15px;
  border-top: 1px solid #eee;
}

.input-group {
  display: flex;
  gap: 5px;
}

#chat-input {
  flex: 1;
  border-radius: 20px;
  padding: 10px 15px;
}

#voice-btn, #send-btn {
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.voice-status {
  margin-top: 5px;
  font-size: 12px;
  color: #666;
  text-align: center;
  min-height: 16px;
}

.listening {
  color: #dc3545;
  font-weight: bold;
}

/* Responsive adjustments */
@media (max-width: 576px) {
  .chatbot-container {
    width: calc(100% - 40px);
    right: 20px;
    left: 20px;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const chatbotContainer = document.getElementById('chatbot-container');
  const chatbotHeader = document.getElementById('chatbot-header');
  const chatbotToggle = document.getElementById('chatbot-toggle');
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const voiceBtn = document.getElementById('voice-btn');
  const voiceStatus = document.getElementById('voice-status');
  
  let recognition = null;
  let isListening = false;
  
  // Initialize speech recognition if available
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';
    
    recognition.onstart = function() {
      isListening = true;
      voiceBtn.classList.add('btn-danger');
      voiceBtn.classList.remove('btn-outline-secondary');
      voiceStatus.textContent = 'Listening...';
      voiceStatus.classList.add('listening');
    };
    
    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      chatInput.value = transcript;
      voiceStatus.textContent = 'Voice input received';
      setTimeout(() => {
        voiceStatus.textContent = '';
      }, 2000);
    };
    
    recognition.onerror = function(event) {
      console.error('Speech recognition error', event.error);
      voiceStatus.textContent = 'Error: ' + event.error;
      setTimeout(() => {
        voiceStatus.textContent = '';
      }, 3000);
    };
    
    recognition.onend = function() {
      isListening = false;
      voiceBtn.classList.remove('btn-danger');
      voiceBtn.classList.add('btn-outline-secondary');
      voiceStatus.classList.remove('listening');
    };
  } else {
    voiceBtn.disabled = true;
    voiceBtn.title = 'Speech recognition not supported';
  }
  
  // Toggle chatbot visibility
  chatbotHeader.addEventListener('click', function() {
    chatbotContainer.classList.toggle('minimized');
    chatbotToggle.textContent = chatbotContainer.classList.contains('minimized') ? '+' : '−';
  });
  
  // Send message function
  async function sendMessage() {
    const message = chatInput.value.trim();
    if (message === '') return;
    
    // Add user message to chat
    addMessage(message, 'user');
    chatInput.value = '';
    
    // Show typing indicator
    const typingIndicator = addTypingIndicator();
    
    try {
      // Get bot response
      const botResponse = await getBotResponse(message);
      
      // Remove typing indicator
      if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.parentNode.removeChild(typingIndicator);
      }
      
      // Add bot response
      addMessage(botResponse, 'bot');
    } catch (error) {
      console.error('Error getting bot response:', error);
      
      // Remove typing indicator
      if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.parentNode.removeChild(typingIndicator);
      }
      
      // Add error message
      addMessage("I'm sorry, I'm having trouble responding right now. Please try again later.", 'bot');
    }
  }
  
  // Add typing indicator
  function addTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message typing-indicator';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = '<i>AI Assistant is typing...</i>';
    
    typingDiv.appendChild(contentDiv);
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return typingDiv;
  }
  
  // Add message to chat
  function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.textContent = text;
    
    messageDiv.appendChild(contentDiv);
    chatMessages.appendChild(messageDiv);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  // Get bot response (actual integration)
  async function getBotResponse(userMessage) {
    try {
      console.log("Sending message to chatbot:", userMessage);
      
      const response = await fetch('/chatbot', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: userMessage })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log("Received response:", data.response);
      return data.response;
    } catch (error) {
      console.error('Error communicating with chatbot:', error);
      return "I'm sorry, I'm having trouble responding right now. Please try again later.";
    }
  }
  
  // Event listeners
  sendBtn.addEventListener('click', sendMessage);
  
  chatInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  
  voiceBtn.addEventListener('click', function() {
    if (!recognition) {
      voiceStatus.textContent = 'Speech recognition not supported in your browser';
      setTimeout(() => {
        voiceStatus.textContent = '';
      }, 3000);
      return;
    }
    
    if (isListening) {
      recognition.stop();
    } else {
      recognition.start();
    }
  });
});
</script>

<!-- Add this CSS for typing indicator -->
<style>
.typing-indicator .message-content {
  font-style: italic;
  color: #666;
  background: #f8f9fa !important;
}

.typing-indicator .message-content i {
  animation: blink 1.5s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
</style>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

{% endblock %}